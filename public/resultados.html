<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados - FullGlobal</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/componentes.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js" defer></script>
   <!-- <script src="js/resultados.js" defer></script> -->
</head>
<body>
    <div class="dashboard-wrapper">
        <header class="dashboard-header">
            <div class="container header-content">
                <div class="logo-brand">
                    <div class="logo-icon">
                        <i class="fas fa-poll"></i>
                    </div>
                    <div class="brand-text">
                        <h1>FullGlobal</h1>
                        <p>Plataforma Profesional de Encuestas</p>
                    </div>
                </div>
                
                <nav>
                    <ul>
                        <li><a href="dashboard.html"><i class="fas fa-home"></i> Inicio</a></li>
                        <li><a href="registro.html"><i class="fas fa-user-plus"></i> Registrar</a></li>
                        <li><a href="admin-encuestas.html"><i class="fas fa-plus-circle"></i> Crear Encuesta</a></li>
                        <li><a href="resultados.html" class="active"><i class="fas fa-chart-bar"></i> Resultados</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <main class="main-content container">
            <div class="page-header">
                <h1><i class="fas fa-chart-line"></i> Resultados de Encuestas</h1>
                <p class="page-subtitle">Visualiza estadísticas y gráficos en tiempo real de todas las encuestas</p>
            </div>
            
            <div class="grid grid-2">
                <!-- Selector de encuesta -->
                <div class="form-card fade-in">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-filter"></i> Seleccionar Encuesta</h2>
                        <p class="card-subtitle">Elige una encuesta para ver sus resultados detallados</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="selectEncuesta" class="form-label">
                            <i class="fas fa-poll-h"></i> Encuesta
                        </label>
                        <select id="selectEncuesta" class="form-control form-select">
                            <option value="">Cargando encuestas...</option>
                        </select>
                    </div>
                    
                    <div class="stats-summary" id="statsSummary" style="display: none;">
                        <div class="stats-grid-small">
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stat-text">
                                    <h3 id="totalVoters">0</h3>
                                    <p>Participantes</p>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fas fa-vote-yea"></i>
                                </div>
                                <div class="stat-text">
                                    <h3 id="totalVotes">0</h3>
                                    <p>Votos Totales</p>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <div class="stat-icon">
                                    <i class="fas fa-percentage"></i>
                                </div>
                                <div class="stat-text">
                                    <h3 id="participationRate">0%</h3>
                                    <p>Tasa de Participación</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Gráfico principal -->
                <div class="form-card fade-in" style="animation-delay: 0.1s;">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-chart-bar"></i> Distribución de Votos</h2>
                        <p class="card-subtitle">Visualización gráfica de los resultados</p>
                    </div>
                    
                    <div class="chart-container">
                        <div style="height: 300px; position: relative;">
                            <canvas id="graficoResultados"></canvas>
                        </div>
                        
                        <div class="chart-legend" id="chartLegend">
                            <!-- La leyenda se generará dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Resultados detallados -->
            <div class="form-card fade-in" style="animation-delay: 0.2s; margin-top: 2rem;">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-list-ol"></i> Resultados Detallados</h2>
                    <p class="card-subtitle">Tabla con el desglose completo de votos por opción</p>
                </div>
                
                <div id="resultadosContainer">
                    <div class="empty-state">
                        <i class="fas fa-chart-pie"></i>
                        <h3>Selecciona una encuesta</h3>
                        <p>Elige una encuesta de la lista para ver los resultados</p>
                    </div>
                </div>
            </div>
            
            <!-- Gráfico circular (dona) -->
            <div class="form-card fade-in" style="animation-delay: 0.3s; margin-top: 2rem;">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-chart-pie"></i> Vista Circular</h2>
                    <p class="card-subtitle">Distribución porcentual de los votos</p>
                </div>
                
                <div class="grid grid-2" style="gap: 3rem;">
                    <div>
                        <div style="height: 300px; position: relative;">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="percentage-breakdown" id="percentageBreakdown">
                        <!-- El desglose porcentual se generará dinámicamente -->
                        <div class="empty-state" style="padding: 1rem;">
                            <p>Los porcentajes aparecerán aquí al seleccionar una encuesta</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="footer">
            <div class="container">
                <p><strong>FullGlobal</strong> - Plataforma de Encuestas Digitales</p>
                <p>Proyecto Final - Laboratorio de Programación III</p>
            </div>
        </footer>
    </div>

    <style>
        /* Estilos específicos para resultados */
        .page-header {
            margin-bottom: 2.5rem;
        }
        
        .page-header h1 {
            color: var(--dark);
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .page-subtitle {
            color: var(--gray);
            font-size: 1.1rem;
            max-width: 700px;
        }
        
        .stats-summary {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--gray-light);
        }
        
        .stats-grid-small {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--light);
            border-radius: 10px;
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            background: var(--primary);
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .stat-text h3 {
            margin: 0;
            color: var(--dark);
            font-size: 1.5rem;
        }
        
        .stat-text p {
            margin: 0;
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .chart-container {
            margin-top: 1rem;
        }
        
        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1.5rem;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: var(--light);
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .results-table th {
            background: var(--light);
            color: var(--dark);
            font-weight: 600;
            text-align: left;
            padding: 1rem;
            border-bottom: 2px solid var(--gray-light);
        }
        
        .results-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .results-table tr:hover {
            background: rgba(247, 250, 252, 0.5);
        }
        
        .option-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .option-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .percentage-bar-container {
            height: 8px;
            background: var(--gray-light);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .percentage-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease;
        }
        
        .percentage-breakdown {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .percentage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--light);
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .percentage-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .percentage-value {
            font-weight: 700;
            font-size: 1.2rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--gray-light);
        }
        
        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--dark);
        }
        
        @media (max-width: 992px) {
            .grid.grid-2 {
                grid-template-columns: 1fr;
            }
            
            .stats-grid-small {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 576px) {
            .stats-grid-small {
                grid-template-columns: 1fr;
            }
        }
    </style>
    
    <script>
        // Variables globales para gráficos
        let barChart = null;
        let pieChartInstance = null;
        let currentChartId = null;
        
        document.addEventListener('DOMContentLoaded', async function() {
            const selectEncuesta = document.getElementById('selectEncuesta');
            const resultadosContainer = document.getElementById('resultadosContainer');
            const statsSummary = document.getElementById('statsSummary');
            
            // Cargar encuestas
            await cargarEncuestas();
            
            // Evento para cambiar encuesta
            selectEncuesta.addEventListener('change', async function() {
                const encuestaId = this.value;
                
                // Si ya estamos mostrando esta encuesta, no hacer nada
                if (currentChartId === encuestaId) return;
                
                if (!encuestaId) {
                    // Mostrar estado vacío
                    resultadosContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-chart-pie"></i>
                            <h3>Selecciona una encuesta</h3>
                            <p>Elige una encuesta de la lista para ver los resultados</p>
                        </div>
                    `;
                    
                    statsSummary.style.display = 'none';
                    
                    // Limpiar gráficos existentes
                    destruirGraficos();
                    
                    document.getElementById('chartLegend').innerHTML = '';
                    document.getElementById('percentageBreakdown').innerHTML = `
                        <div class="empty-state" style="padding: 1rem;">
                            <p>Los porcentajes aparecerán aquí al seleccionar una encuesta</p>
                        </div>
                    `;
                    
                    currentChartId = null;
                    return;
                }
                
                // Actualizar ID actual
                currentChartId = encuestaId;
                
                await cargarResultados(encuestaId);
            });
            
            // Función para destruir gráficos existentes
            function destruirGraficos() {
                if (barChart) {
                    try {
                        barChart.destroy();
                    } catch (e) {
                        console.warn('Error destruyendo barChart:', e);
                    }
                    barChart = null;
                }
                
                if (pieChartInstance) {
                    try {
                        pieChartInstance.destroy();
                    } catch (e) {
                        console.warn('Error destruyendo pieChartInstance:', e);
                    }
                    pieChartInstance = null;
                }
                
                // Limpiar canvas manualmente por si acaso
                const barCanvas = document.getElementById('graficoResultados');
                const pieCanvas = document.getElementById('pieChart');
                
                if (barCanvas) {
                    const ctx = barCanvas.getContext('2d');
                    ctx.clearRect(0, 0, barCanvas.width, barCanvas.height);
                }
                
                if (pieCanvas) {
                    const ctx = pieCanvas.getContext('2d');
                    ctx.clearRect(0, 0, pieCanvas.width, pieCanvas.height);
                }
            }
            
            async function cargarEncuestas() {
                try {
                    const { data: encuestas, error } = await supabase
                        .from('encuestas')
                        .select('id, titulo, activa')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    selectEncuesta.innerHTML = '<option value="">Selecciona una encuesta</option>';
                    encuestas.forEach(encuesta => {
                        const option = document.createElement('option');
                        option.value = encuesta.id;
                        option.textContent = `${encuesta.titulo} ${encuesta.activa ? '' : '(Inactiva)'}`;
                        if (!encuesta.activa) option.disabled = true;
                        selectEncuesta.appendChild(option);
                    });
                    
                } catch (error) {
                    console.error('Error al cargar encuestas:', error);
                    selectEncuesta.innerHTML = '<option value="">Error al cargar encuestas</option>';
                }
            }
            
            async function cargarResultados(encuestaId) {
                // Mostrar estado de carga
                resultadosContainer.innerHTML = `
                    <div class="loading-state">
                        <div class="loader"></div>
                        <p>Cargando resultados...</p>
                    </div>
                `;
                
                statsSummary.style.display = 'none';
                
                try {
                    // Obtener resultados usando la vista
                    const { data: resultados, error } = await supabase
                        .from('resultados_encuestas')
                        .select('*')
                        .eq('encuesta_id', encuestaId)
                        .order('orden');
                    
                    if (error) throw error;
                    
                    if (!resultados || resultados.length === 0) {
                        resultadosContainer.innerHTML = `
                            <div class="empty-state">
                                <i class="fas fa-chart-bar"></i>
                                <h3>No hay resultados aún</h3>
                                <p>Aún no hay votos registrados para esta encuesta.</p>
                            </div>
                        `;
                        
                        // Limpiar gráficos
                        destruirGraficos();
                        document.getElementById('chartLegend').innerHTML = '';
                        document.getElementById('percentageBreakdown').innerHTML = `
                            <div class="empty-state" style="padding: 1rem;">
                                <p>No hay datos para mostrar</p>
                            </div>
                        `;
                        
                        return;
                    }
                    
                    // Destruir gráficos anteriores antes de crear nuevos
                    destruirGraficos();
                    
                    // Mostrar estadísticas
                    mostrarEstadisticas(resultados);
                    
                    // Crear gráficos
                    crearGraficos(resultados);
                    
                    // Mostrar tabla de resultados
                    mostrarTablaResultados(resultados);
                    
                } catch (error) {
                    console.error('Error al cargar resultados:', error);
                    resultadosContainer.innerHTML = `
                        <div class="alert alert-error">
                            <div class="alert-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="alert-content">
                                <p class="alert-title">Error al cargar resultados</p>
                                <p class="alert-message">${error.message}</p>
                            </div>
                        </div>
                    `;
                    
                    // Asegurarse de limpiar gráficos en caso de error
                    destruirGraficos();
                }
            }
            
            function mostrarEstadisticas(resultados) {
                const totalVotos = resultados.reduce((sum, r) => sum + (r.total_votos || 0), 0);
                
                document.getElementById('totalVotes').textContent = totalVotos;
                document.getElementById('totalVoters').textContent = totalVotos;
                document.getElementById('participationRate').textContent = '100%';
                
                statsSummary.style.display = 'block';
            }
            
            function crearGraficos(resultados) {
                const labels = resultados.map(r => r.nombre_opcion);
                const datos = resultados.map(r => r.total_votos || 0);
                const porcentajes = resultados.map(r => r.porcentaje || 0);
                
                // Colores para gráficos
                const colores = [
                    '#4c51bf', '#805ad5', '#38a169', '#e53e3e', 
                    '#d69e2e', '#319795', '#d53f8c', '#3182ce',
                    '#63b3ed', '#68d391', '#fbb6ce', '#f6ad55'
                ];
                
                // Obtener contexto del canvas
                const barCanvas = document.getElementById('graficoResultados');
                const pieCanvas = document.getElementById('pieChart');
                
                // Asegurar que los canvas estén listos
                if (!barCanvas || !pieCanvas) {
                    console.error('No se encontraron los elementos canvas');
                    return;
                }
                
                // Gráfico de barras
                const barCtx = barCanvas.getContext('2d');
                barChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Votos',
                            data: datos,
                            backgroundColor: colores,
                            borderColor: colores.map(c => c.replace('0.8', '1')),
                            borderWidth: 1,
                            borderRadius: 6,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const porcentaje = porcentajes[context.dataIndex];
                                        return `Votos: ${context.raw} (${porcentaje}%)`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1,
                                    precision: 0
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                
                // Gráfico circular (dona)
                const pieCtx = pieCanvas.getContext('2d');
                pieChartInstance = new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: datos,
                            backgroundColor: colores,
                            borderColor: 'white',
                            borderWidth: 2,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const porcentaje = porcentajes[context.dataIndex];
                                        return `${context.label}: ${context.raw} votos (${porcentaje}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Crear leyenda
                crearLeyenda(labels, colores, porcentajes);
                
                // Crear desglose porcentual
                crearDesglosePorcentual(resultados, colores);
            }
            
            function crearLeyenda(labels, colores, porcentajes) {
                const legendContainer = document.getElementById('chartLegend');
                let legendHTML = '';
                
                labels.forEach((label, index) => {
                    legendHTML += `
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${colores[index]}"></div>
                            <span>${label}</span>
                            <strong>${porcentajes[index]}%</strong>
                        </div>
                    `;
                });
                
                legendContainer.innerHTML = legendHTML;
            }
            
            function crearDesglosePorcentual(resultados, colores) {
                const breakdownContainer = document.getElementById('percentageBreakdown');
                let breakdownHTML = '';
                
                resultados.forEach((resultado, index) => {
                    breakdownHTML += `
                        <div class="percentage-item" style="border-left-color: ${colores[index]}">
                            <div class="percentage-info">
                                <div class="option-color" style="background: ${colores[index]}"></div>
                                <div>
                                    <h4 style="margin: 0; font-size: 1rem;">${resultado.nombre_opcion}</h4>
                                    <p style="margin: 0; font-size: 0.85rem; color: var(--gray);">
                                        ${resultado.total_votos || 0} votos
                                    </p>
                                </div>
                            </div>
                            <div class="percentage-value">
                                ${resultado.porcentaje || 0}%
                            </div>
                        </div>
                    `;
                });
                
                breakdownContainer.innerHTML = breakdownHTML;
            }
            
            function mostrarTablaResultados(resultados) {
                const colores = [
                    '#4c51bf', '#805ad5', '#38a169', '#e53e3e', 
                    '#d69e2e', '#319795', '#d53f8c', '#3182ce'
                ];
                
                let tableHTML = `
                    <div class="table-container">
                        <table class="results-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%;">Opción</th>
                                    <th style="width: 15%; text-align: center;">Votos</th>
                                    <th style="width: 15%; text-align: center;">Porcentaje</th>
                                    <th style="width: 30%;">Distribución</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                resultados.forEach((resultado, index) => {
                    tableHTML += `
                        <tr>
                            <td>
                                <div class="option-cell">
                                    <div class="option-color" style="background: ${colores[index % colores.length]}"></div>
                                    <div>
                                        <strong>${resultado.nombre_opcion}</strong>
                                        ${resultado.descripcion ? `<br><small style="color: var(--gray);">${resultado.descripcion}</small>` : ''}
                                    </div>
                                </div>
                            </td>
                            <td style="text-align: center; font-weight: 700; font-size: 1.2rem;">
                                ${resultado.total_votos || 0}
                            </td>
                            <td style="text-align: center;">
                                <span style="background: rgba(76, 81, 191, 0.1); color: var(--primary); padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600;">
                                    ${resultado.porcentaje || 0}%
                                </span>
                            </td>
                            <td>
                                <div class="percentage-bar-container">
                                    <div class="percentage-bar" style="width: ${resultado.porcentaje || 0}%; background: ${colores[index % colores.length]}"></div>
                                </div>
                                <div style="text-align: center; margin-top: 0.25rem; font-size: 0.85rem; color: var(--gray);">
                                    ${resultado.total_votos || 0} de ${resultados.reduce((sum, r) => sum + (r.total_votos || 0), 0)} votos
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                resultadosContainer.innerHTML = tableHTML;
            }
        });
    </script>
</body>
</html>